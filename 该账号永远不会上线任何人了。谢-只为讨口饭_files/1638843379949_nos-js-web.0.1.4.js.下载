!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["@winman-f2e/nos-js-web"]={})}(this,(function(t){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},r={},n={},o={},i={};Object.defineProperty(i,"__esModule",{value:!0}),i.default={NOS_UPLOAD:{url:"https://nos.netease.com/{bucketName}",method:"POST"},NOS_GET_OBJECT:{url:"https://nos.netease.com/{bucketName}/{objectKey}"},NOS_BLOCK_UPLOAD:{url:"https://nosup-hz1.127.net/{bucketName}/{objectKey}",method:"POST"},FETCH_BLOCK_UPLOAD_CONTEXT:{url:"https://nosup-hz1.127.net/{bucketName}/{objectKey}",method:"GET"},FETCH_BLOCK_UPLOAD_SERVER:{url:"https://nos.netease.com/lbs",method:"GET"},NOS_CONCURRENT_UPLOAD:{url:"https://nos.netease.com/{bucketName}/{objectKey}"}};var a={},s={},u={};Object.defineProperty(u,"__esModule",{value:!0}),u.default=function(t){return!this||"function"!=typeof this.isNOSObject||this.isNOSObject(t)};var l=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(s,"__esModule",{value:!0});var f=l(u);s.default=function(t){if(f.default(t))return t+"?exif"};var c={},p={};Object.defineProperty(p,"__esModule",{value:!0}),p.checkIsGif=void 0,p.checkIsGif=function(t){return/\.gif($|\?|#)/.test(t)};var d=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(c,"__esModule",{value:!0});var h=d(u),g=p,v={inside:"x",crop:"y",outside:"z"};c.default=function(t,e,r,n,o){if(void 0===e&&(e={}),void 0===r&&(r="inside"),void 0===n&&(n=!0),void 0===o&&(o=!1),!t)return"";if(n&&(!e||!h.default(t)))return t;var i=e.width,a=void 0===i?0:i,s=e.height,u=void 0===s?0:s,l="";if(l=t.indexOf("vframe")>=0?"resize="+a+"x"+u:a||u?"imageView&thumbnail="+a+v[r]+u:"imageView",o&&g.checkIsGif(t)&&(l+="&tostatic=0"),t.indexOf("?")>=0){var f=t.indexOf("?"),c=t.slice(0,f),p=t.slice(f+1);return c+"?"+l+"&"+(p=p.replace(/&?(imageView|thumbnail=[^&]+|tostatic=[^&]+)/g,""))}return t+"?"+l};var b={},y=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(b,"__esModule",{value:!0});var m=y(u);b.default=function(t){if(m.default(t))return t+"?vinfo"};var _={},O=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(_,"__esModule",{value:!0});var N=O(u);_.default=function(t){if(N.default(t))return t+"?vframe"};var P={};Object.defineProperty(P,"__esModule",{value:!0}),P.default=function(t){if(this&&(this._apis,1)&&this._apis.NOS_GET_OBJECT)return this._apis.NOS_GET_OBJECT.url.replace(/\{(\w+)\}/g,(function(e,r){return t[r]||""}));throw new Error("NOS_GET_OBJECT not found")};var w={},A={};Object.defineProperty(A,"__esModule",{value:!0}),A.stringifyMediaQuery=A.parseMediaQuery=void 0,A.parseMediaQuery=function(t){var e=t.split("?"),r=e[0],n=e[1],o=(n=n||"").split(/\||%7C/).map((function(t){var e=t.split("&"),r={};return e.forEach((function(t){var e=t.split("="),n=e[0],o=e.slice(1);o.length>0?r[n]=decodeURIComponent(o.join("=")):r[n]=!0})),r}));return{path:r,queries:o}},A.stringifyMediaQuery=function(t){return t.path+"?"+t.queries.map((function(t){return Object.keys(t).map((function(e){return!0===t[e]?e:e+"="+encodeURIComponent(t[e])})).join("&")})).join("%7C")};var x=e&&e.__assign||function(){return x=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},x.apply(this,arguments)},S=e&&e.__rest||function(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(t);o<n.length;o++)e.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(t,n[o])&&(r[n[o]]=t[n[o]])}return r},C=e&&e.__spreadArray||function(t,e){for(var r=0,n=e.length,o=t.length;r<n;r++,o++)t[o]=e[r];return t};Object.defineProperty(w,"__esModule",{value:!0}),w.getImageWatermark=void 0;var k=A;w.getImageWatermark=function(t,e){var r=e.onlyUpdate,n=void 0===r||r,o=S(e,["onlyUpdate"]),i=k.parseMediaQuery(t),a=i.path,s=i.queries,u=s.findIndex((function(t){return t.watermark}));if(n&&-1===u)return t;var l=C([],s),f=x(-1!==u?x({},s[u]):{watermark:!0},o);return-1!==u?l[u]=f:l.push(f),k.stringifyMediaQuery({path:a,queries:l})},function(t){var r=e&&e.__createBinding||(Object.create?function(t,e,r,n){void 0===n&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){void 0===n&&(n=r),t[n]=e[r]}),n=e&&e.__exportStar||function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||r(e,t,n)},o=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(t,"__esModule",{value:!0}),t.getImageWatermark=t.getObjectUrl=t.getVideoPosterUrl=t.getVideoInfoAPI=t.getImageThumbnailUrl=t.getImageExifAPI=void 0;var i=s;Object.defineProperty(t,"getImageExifAPI",{enumerable:!0,get:function(){return o(i).default}});var a=c;Object.defineProperty(t,"getImageThumbnailUrl",{enumerable:!0,get:function(){return o(a).default}});var u=b;Object.defineProperty(t,"getVideoInfoAPI",{enumerable:!0,get:function(){return o(u).default}});var l=_;Object.defineProperty(t,"getVideoPosterUrl",{enumerable:!0,get:function(){return o(l).default}});var f=P;Object.defineProperty(t,"getObjectUrl",{enumerable:!0,get:function(){return o(f).default}});var d=w;Object.defineProperty(t,"getImageWatermark",{enumerable:!0,get:function(){return d.getImageWatermark}}),n(p,t)}(a);var E=e&&e.__assign||function(){return E=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},E.apply(this,arguments)},T=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(o,"__esModule",{value:!0}),o.NOSClass=void 0;var j=T(i),I=a,U=function(){function t(t){this._apis=j.default,this.uploadAdapter=null,this.fetchAdapter=null,this.getNOSToken=null,this.getImageExifAPI=I.getImageExifAPI,this.getImageThumbnailUrl=I.getImageThumbnailUrl,this.getImageWatermark=I.getImageWatermark,this.getVideoInfoAPI=I.getVideoInfoAPI,this.getVideoPosterUrl=I.getVideoPosterUrl,this.getObjectUrl=I.getObjectUrl,this.checkIsGif=I.checkIsGif,this.Uploader=t}return t.prototype.useAdapter=function(t){this.uploadAdapter=t},t.prototype.useFetchAdapter=function(t){this.fetchAdapter=t},t.prototype.useGetToken=function(t){this.getNOSToken=t},t.prototype.updateAPI=function(t){this._apis=E(E({},this._apis),t)},t.prototype.isNOSObject=function(t){var e=this._apis.NOS_GET_OBJECT,r=e&&e.url;if(!r)throw new Error("NOS_GET_OBJECT not found");return new RegExp("^"+r.replace(/{\w+}/g,"\\w+")).test(t)},t.prototype.createUploadTask=function(t,e){if(!this.uploadAdapter)throw new Error("uploader adapter not found");if(!this.getNOSToken&&!e)throw new Error("getNotToken adapter or uploaderSignature not found");if(!this.fetchAdapter)throw new Error("fetchAdapter adapter not found");return new this.Uploader({apis:this._apis,file:t,adapter:this.uploadAdapter,getNOSToken:this.getNOSToken,uploaderSignature:e,fetchAdapter:this.fetchAdapter,storage:this.storage})},t.prototype.getVideoInfo=function(t){if(!this.fetchAdapter)throw new Error("fetch adapter not found");var e=this.getVideoInfoAPI(t);return e?this.fetchAdapter({url:e,method:"GET"}).then((function(t){return t.body})):Promise.reject("video not in nos")},t}();o.NOSClass=U;var M={},B={},D={exports:{}};!function(t,e){t.exports=function(t){var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function r(t,e){var r=t[0],n=t[1],o=t[2],i=t[3];n=((n+=((o=((o+=((i=((i+=((r=((r+=(n&o|~n&i)+e[0]-680876936|0)<<7|r>>>25)+n|0)&n|~r&o)+e[1]-389564586|0)<<12|i>>>20)+r|0)&r|~i&n)+e[2]+606105819|0)<<17|o>>>15)+i|0)&i|~o&r)+e[3]-1044525330|0)<<22|n>>>10)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n&o|~n&i)+e[4]-176418897|0)<<7|r>>>25)+n|0)&n|~r&o)+e[5]+1200080426|0)<<12|i>>>20)+r|0)&r|~i&n)+e[6]-1473231341|0)<<17|o>>>15)+i|0)&i|~o&r)+e[7]-45705983|0)<<22|n>>>10)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n&o|~n&i)+e[8]+1770035416|0)<<7|r>>>25)+n|0)&n|~r&o)+e[9]-1958414417|0)<<12|i>>>20)+r|0)&r|~i&n)+e[10]-42063|0)<<17|o>>>15)+i|0)&i|~o&r)+e[11]-1990404162|0)<<22|n>>>10)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n&o|~n&i)+e[12]+1804603682|0)<<7|r>>>25)+n|0)&n|~r&o)+e[13]-40341101|0)<<12|i>>>20)+r|0)&r|~i&n)+e[14]-1502002290|0)<<17|o>>>15)+i|0)&i|~o&r)+e[15]+1236535329|0)<<22|n>>>10)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n&i|o&~i)+e[1]-165796510|0)<<5|r>>>27)+n|0)&o|n&~o)+e[6]-1069501632|0)<<9|i>>>23)+r|0)&n|r&~n)+e[11]+643717713|0)<<14|o>>>18)+i|0)&r|i&~r)+e[0]-373897302|0)<<20|n>>>12)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n&i|o&~i)+e[5]-701558691|0)<<5|r>>>27)+n|0)&o|n&~o)+e[10]+38016083|0)<<9|i>>>23)+r|0)&n|r&~n)+e[15]-660478335|0)<<14|o>>>18)+i|0)&r|i&~r)+e[4]-405537848|0)<<20|n>>>12)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n&i|o&~i)+e[9]+568446438|0)<<5|r>>>27)+n|0)&o|n&~o)+e[14]-1019803690|0)<<9|i>>>23)+r|0)&n|r&~n)+e[3]-187363961|0)<<14|o>>>18)+i|0)&r|i&~r)+e[8]+1163531501|0)<<20|n>>>12)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n&i|o&~i)+e[13]-1444681467|0)<<5|r>>>27)+n|0)&o|n&~o)+e[2]-51403784|0)<<9|i>>>23)+r|0)&n|r&~n)+e[7]+1735328473|0)<<14|o>>>18)+i|0)&r|i&~r)+e[12]-1926607734|0)<<20|n>>>12)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n^o^i)+e[5]-378558|0)<<4|r>>>28)+n|0)^n^o)+e[8]-2022574463|0)<<11|i>>>21)+r|0)^r^n)+e[11]+1839030562|0)<<16|o>>>16)+i|0)^i^r)+e[14]-35309556|0)<<23|n>>>9)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n^o^i)+e[1]-1530992060|0)<<4|r>>>28)+n|0)^n^o)+e[4]+1272893353|0)<<11|i>>>21)+r|0)^r^n)+e[7]-155497632|0)<<16|o>>>16)+i|0)^i^r)+e[10]-1094730640|0)<<23|n>>>9)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n^o^i)+e[13]+681279174|0)<<4|r>>>28)+n|0)^n^o)+e[0]-358537222|0)<<11|i>>>21)+r|0)^r^n)+e[3]-722521979|0)<<16|o>>>16)+i|0)^i^r)+e[6]+76029189|0)<<23|n>>>9)+o|0,n=((n+=((o=((o+=((i=((i+=((r=((r+=(n^o^i)+e[9]-640364487|0)<<4|r>>>28)+n|0)^n^o)+e[12]-421815835|0)<<11|i>>>21)+r|0)^r^n)+e[15]+530742520|0)<<16|o>>>16)+i|0)^i^r)+e[2]-995338651|0)<<23|n>>>9)+o|0,n=((n+=((i=((i+=(n^((r=((r+=(o^(n|~i))+e[0]-198630844|0)<<6|r>>>26)+n|0)|~o))+e[7]+1126891415|0)<<10|i>>>22)+r|0)^((o=((o+=(r^(i|~n))+e[14]-1416354905|0)<<15|o>>>17)+i|0)|~r))+e[5]-57434055|0)<<21|n>>>11)+o|0,n=((n+=((i=((i+=(n^((r=((r+=(o^(n|~i))+e[12]+1700485571|0)<<6|r>>>26)+n|0)|~o))+e[3]-1894986606|0)<<10|i>>>22)+r|0)^((o=((o+=(r^(i|~n))+e[10]-1051523|0)<<15|o>>>17)+i|0)|~r))+e[1]-2054922799|0)<<21|n>>>11)+o|0,n=((n+=((i=((i+=(n^((r=((r+=(o^(n|~i))+e[8]+1873313359|0)<<6|r>>>26)+n|0)|~o))+e[15]-30611744|0)<<10|i>>>22)+r|0)^((o=((o+=(r^(i|~n))+e[6]-1560198380|0)<<15|o>>>17)+i|0)|~r))+e[13]+1309151649|0)<<21|n>>>11)+o|0,n=((n+=((i=((i+=(n^((r=((r+=(o^(n|~i))+e[4]-145523070|0)<<6|r>>>26)+n|0)|~o))+e[11]-1120210379|0)<<10|i>>>22)+r|0)^((o=((o+=(r^(i|~n))+e[2]+718787259|0)<<15|o>>>17)+i|0)|~r))+e[9]-343485551|0)<<21|n>>>11)+o|0,t[0]=r+t[0]|0,t[1]=n+t[1]|0,t[2]=o+t[2]|0,t[3]=i+t[3]|0}function n(t){var e,r=[];for(e=0;e<64;e+=4)r[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return r}function o(t){var e,r=[];for(e=0;e<64;e+=4)r[e>>2]=t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24);return r}function i(t){var e,o,i,a,s,u,l=t.length,f=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=l;e+=64)r(f,n(t.substring(e-64,e)));for(o=(t=t.substring(e-64)).length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<o;e+=1)i[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(i[e>>2]|=128<<(e%4<<3),e>55)for(r(f,i),e=0;e<16;e+=1)i[e]=0;return a=(a=8*l).toString(16).match(/(.*?)(.{0,8})$/),s=parseInt(a[2],16),u=parseInt(a[1],16)||0,i[14]=s,i[15]=u,r(f,i),f}function a(t){var e,n,i,a,s,u,l=t.length,f=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=l;e+=64)r(f,o(t.subarray(e-64,e)));for(n=(t=e-64<l?t.subarray(e-64):new Uint8Array(0)).length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)i[e>>2]|=t[e]<<(e%4<<3);if(i[e>>2]|=128<<(e%4<<3),e>55)for(r(f,i),e=0;e<16;e+=1)i[e]=0;return a=(a=8*l).toString(16).match(/(.*?)(.{0,8})$/),s=parseInt(a[2],16),u=parseInt(a[1],16)||0,i[14]=s,i[15]=u,r(f,i),f}function s(t){var r,n="";for(r=0;r<4;r+=1)n+=e[t>>8*r+4&15]+e[t>>8*r&15];return n}function u(t){var e;for(e=0;e<t.length;e+=1)t[e]=s(t[e]);return t.join("")}function l(t){return/[\u0080-\uFFFF]/.test(t)&&(t=unescape(encodeURIComponent(t))),t}function f(t,e){var r,n=t.length,o=new ArrayBuffer(n),i=new Uint8Array(o);for(r=0;r<n;r+=1)i[r]=t.charCodeAt(r);return e?i:o}function c(t){return String.fromCharCode.apply(null,new Uint8Array(t))}function p(t,e,r){var n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t)),n.set(new Uint8Array(e),t.byteLength),r?n:n.buffer}function d(t){var e,r=[],n=t.length;for(e=0;e<n-1;e+=2)r.push(parseInt(t.substr(e,2),16));return String.fromCharCode.apply(String,r)}function h(){this.reset()}return u(i("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function e(t,e){return(t=0|t||0)<0?Math.max(t+e,0):Math.min(t,e)}ArrayBuffer.prototype.slice=function(r,n){var o,i,a,s,u=this.byteLength,l=e(r,u),f=u;return n!==t&&(f=e(n,u)),l>f?new ArrayBuffer(0):(o=f-l,i=new ArrayBuffer(o),a=new Uint8Array(i),s=new Uint8Array(this,l,o),a.set(s),i)}}(),h.prototype.append=function(t){return this.appendBinary(l(t)),this},h.prototype.appendBinary=function(t){this._buff+=t,this._length+=t.length;var e,o=this._buff.length;for(e=64;e<=o;e+=64)r(this._hash,n(this._buff.substring(e-64,e)));return this._buff=this._buff.substring(e-64),this},h.prototype.end=function(t){var e,r,n=this._buff,o=n.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<o;e+=1)i[e>>2]|=n.charCodeAt(e)<<(e%4<<3);return this._finish(i,o),r=u(this._hash),t&&(r=d(r)),this.reset(),r},h.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},h.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},h.prototype.setState=function(t){return this._buff=t.buff,this._length=t.length,this._hash=t.hash,this},h.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},h.prototype._finish=function(t,e){var n,o,i,a=e;if(t[a>>2]|=128<<(a%4<<3),a>55)for(r(this._hash,t),a=0;a<16;a+=1)t[a]=0;n=(n=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(n[2],16),i=parseInt(n[1],16)||0,t[14]=o,t[15]=i,r(this._hash,t)},h.hash=function(t,e){return h.hashBinary(l(t),e)},h.hashBinary=function(t,e){var r=u(i(t));return e?d(r):r},h.ArrayBuffer=function(){this.reset()},h.ArrayBuffer.prototype.append=function(t){var e,n=p(this._buff.buffer,t,!0),i=n.length;for(this._length+=t.byteLength,e=64;e<=i;e+=64)r(this._hash,o(n.subarray(e-64,e)));return this._buff=e-64<i?new Uint8Array(n.buffer.slice(e-64)):new Uint8Array(0),this},h.ArrayBuffer.prototype.end=function(t){var e,r,n=this._buff,o=n.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<o;e+=1)i[e>>2]|=n[e]<<(e%4<<3);return this._finish(i,o),r=u(this._hash),t&&(r=d(r)),this.reset(),r},h.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},h.ArrayBuffer.prototype.getState=function(){var t=h.prototype.getState.call(this);return t.buff=c(t.buff),t},h.ArrayBuffer.prototype.setState=function(t){return t.buff=f(t.buff,!0),h.prototype.setState.call(this,t)},h.ArrayBuffer.prototype.destroy=h.prototype.destroy,h.ArrayBuffer.prototype._finish=h.prototype._finish,h.ArrayBuffer.hash=function(t,e){var r=u(a(new Uint8Array(t)));return e?d(r):r},h}()}(D);var F={},R={},L={};Object.defineProperty(L,"__esModule",{value:!0}),L.DID_DESTROY=L.WILL_DESTROY=void 0,L.WILL_DESTROY="willDestroy",L.DID_DESTROY="didDestroy";var V={};Object.defineProperty(V,"__esModule",{value:!0}),V.default=function(t,e,r){var n=e[t];"function"==typeof n&&n.apply(e,r),"function"==typeof e.emit&&e.emit(t,r)};var z={};Object.defineProperty(z,"__esModule",{value:!0}),z.Event=void 0;var K=function(){function t(t){var e=t.data,r=t.target,n=t.type;return this.data=e,this.target=r,this.type=n,this}return t.isEvent=function(e){return e&&e instanceof t},t}();z.Event=K;var W=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(R,"__esModule",{value:!0}),R.EventEmitter=void 0;var G=L,J=W(V),H=z,X=function(){function t(){this._batch=!1,this._paddingEvents=[],this._events={},this._destroyed=!1}return t.prototype.emit=function(t,e){var r;if(r=H.Event.isEvent(t)?t:new H.Event({target:this,data:e,type:t}),this._batch)this.addPaddingEvent(r);else{var n=r.type,o=this._events[n];o&&o.forEach((function(t){t(r)}))}},t.prototype.batchEmit=function(t){this._batch=!0,t(),this._batch=!1,this.runPaddingEvents()},t.prototype.addPaddingEvent=function(t){this._paddingEvents.push(t)},t.prototype.runPaddingEvents=function(){var t=this._paddingEvents,e={};for(var r in t.forEach((function(t){e[t.type]=t})),e)e[r]&&this.emit(e[r]);this._paddingEvents=[]},t.prototype.addListener=function(t,e){var r=this,n=function(){};if(this._destroyed)return n;if(e){var o=this._events[t];o||(o=[],this._events[t]=o),o.push(e)}return e&&(n=function(){r.removeListener(e)}),n},t.prototype.removeListener=function(t,e){var r,n,o=this;if(!this._destroyed)if("string"==typeof t?(r=t,n=e):n=t,r){var i=this._events;i[r]&&this._remove(i[r],n)}else{var a=this._events;Object.keys(a).forEach((function(t){o._remove(a[t],n)}))}},t.prototype._remove=function(t,e){var r=t.findIndex((function(t){return t===e}));r>-1&&t.splice(r,1)},t.prototype.destroy=function(){J.default(G.WILL_DESTROY,this),this._events={},this._destroyed=!0,J.default(G.DID_DESTROY,this)},t}();R.EventEmitter=X,function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.Event=t.EventEmitter=void 0;var e=R;Object.defineProperty(t,"EventEmitter",{enumerable:!0,get:function(){return e.EventEmitter}});var r=z;Object.defineProperty(t,"Event",{enumerable:!0,get:function(){return r.Event}})}(F);var q={};Object.defineProperty(q,"__esModule",{value:!0}),q.logTimeEnd=q.logTime=q.log=void 0,q.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},q.logTime=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},q.logTimeEnd=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]};var Y,$=e&&e.__extends||(Y=function(t,e){return Y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},Y(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}Y(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Q=e&&e.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{u(n.next(t))}catch(t){i(t)}}function s(t){try{u(n.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((n=n.apply(t,e||[])).next())}))},Z=e&&e.__generator||function(t,e){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},tt=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(B,"__esModule",{value:!0});var et=tt(D.exports),rt=q,nt=0,ot=function(t){function e(e){var r=e.apis,n=e.adapter,o=e.file,i=e.getNOSToken,a=e.uploaderSignature,s=e.fetchAdapter,u=e.storage,l=t.call(this)||this;return l.id=++nt,l._aborted=!1,l.uploadInfo={percent:0,timestamp:(new Date).getTime()},l.fileKeyPrefix="",l._apis=r,l._adapter=n,l._originFile=o,i&&(l._getNOSToken=i),a&&(l.signature=a),l._fetchAdapter=s,l.storage=u,l.fileKey=l.createFileKey(),l}return $(e,t),e.prototype.createFileKey=function(){var t=this._originFile,e=this.fileKeyPrefix+"_"+t.name+"_"+t.size+"_"+t.lastModified;return et.default.hash(e)},e.prototype.abort=function(){this._aborted=!0,this._abort&&this._abort()},e.prototype.getNOSTokenFromRemote=function(){return Q(this,void 0,void 0,(function(){var t;return Z(this,(function(e){switch(e.label){case 0:return this._getNOSToken?[4,this._getNOSToken(this)]:[3,2];case 1:t=e.sent(),e.label=2;case 2:return[2,t]}}))}))},e.prototype.getNOSToken=function(){return Q(this,void 0,void 0,(function(){var t,e;return Z(this,(function(r){switch(r.label){case 0:return(e=this.signature)?[3,2]:[4,this.getNOSTokenFromRemote()];case 1:e=r.sent(),r.label=2;case 2:if(!(t=e))throw new Error("nos signature not found");return this.emit("getToken",t),[2,t]}}))}))},e.prototype.setComplete=function(){this.uploadInfo.percent=1,this.uploadedInfo={objectKey:this.signature.objectKey,bucketName:this.signature.bucketName},this.emit("complete",this.uploadedInfo)},e.prototype.isCompleted=function(){return!!this.uploadedInfo},e.prototype.setError=function(t){this.uploadError=t,this.emit("error",t)},e.prototype.updateProgress=function(t){this.uploadInfo={percent:t.percent,sent:t.sent,total:t.total,timestamp:(new Date).getTime()},this.emit("progress",this.uploadInfo)},e.prototype.generateFileMD5=function(){var t=this;return new Promise((function(e,r){var n=t._originFile;if(!n)throw new Error("no file");rt.logTime("md5");var o=4194304,i=Math.ceil(n.size/o),a=0,s=new et.default.ArrayBuffer,u=new FileReader;function l(){return Q(this,void 0,void 0,(function(){var t,e;return Z(this,(function(r){return e=(t=a*o)+o>=n.size?n.size:t+o,u.readAsArrayBuffer(n.slice(t,e)),[2]}))}))}u.onload=function(t){var r,o=null===(r=t.target)||void 0===r?void 0:r.result;if(o&&s.append(o),++a<i)l();else{var u=s.end();rt.log("md5 计算完成",u,n.name,new Date),rt.logTimeEnd("md5"),e(u)}},u.onerror=function(t){r(t)},l()}))},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.uploadedInfo||this.abort()},e}(F.EventEmitter);B.default=ot;var it,at=e&&e.__extends||(it=function(t,e){return it=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},it(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}it(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),st=e&&e.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{u(n.next(t))}catch(t){i(t)}}function s(t){try{u(n.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((n=n.apply(t,e||[])).next())}))},ut=e&&e.__generator||function(t,e){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},lt=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(M,"__esModule",{value:!0});var ft=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return at(e,t),e.prototype.upload=function(){return st(this,void 0,void 0,(function(){var t,e,r,n=this;return ut(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,this.getNOSToken()];case 1:return t=o.sent(),[3,3];case 2:return e=o.sent(),this.setError(e),[2,Promise.reject(e)];case 3:return r=this._apis.NOS_UPLOAD.url.replace(/\{(\w+)\}/g,(function(e,r){return t[r]||""})),this.signature=t,[2,new Promise((function(e,o){var i=n._adapter({url:r,fileKey:"file",type:"form",file:n._originFile,headers:{"x-nos-token":t.token},data:{Object:t.objectKey,"x-nos-token":t.token},success:function(){return st(n,void 0,void 0,(function(){return ut(this,(function(t){switch(t.label){case 0:return[4,this.setComplete()];case 1:return t.sent(),e(this.uploadedInfo),[2]}}))}))},error:function(t){n.setError(t),o(t)},progress:function(t){n.updateProgress(t)}}).abort;n._abort=i}))]}}))}))},e}(lt(B).default);M.default=ft;var ct={},pt={};Object.defineProperty(pt,"__esModule",{value:!0}),pt.default={BLOCK_SIZE:10485760};var dt={};Object.defineProperty(dt,"__esModule",{value:!0}),dt.fileSlice=dt.urlReplace=void 0,dt.urlReplace=function(t,e){return t.replace(/\{(\w+)\}/g,(function(t,r){return e[r]||""}))},dt.fileSlice=function(t,e,r){var n=Math.min(e+r,t.size);return t.slice(e,n)};var ht,gt=e&&e.__extends||(ht=function(t,e){return ht=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},ht(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}ht(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),vt=e&&e.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{u(n.next(t))}catch(t){i(t)}}function s(t){try{u(n.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((n=n.apply(t,e||[])).next())}))},bt=e&&e.__generator||function(t,e){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},yt=e&&e.__spreadArray||function(t,e){for(var r=0,n=e.length,o=t.length;r<n;r++,o++)t[o]=e[r];return t},mt=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(ct,"__esModule",{value:!0});var _t=mt(pt),Ot=mt(B),Nt=dt,Pt=q,wt={},At=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.blockSize=_t.default.BLOCK_SIZE,e._aborted=!1,e.blockUploadInfo={offset:0,context:""},e.retryCount=0,e}return gt(e,t),e.prototype.clearRetry=function(){this.retryCount=0},e.prototype.createRetry=function(t,e){var r=this;return void 0===e&&(e=2),function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];return r.retryCount>=e?(r.setError("retry too much"),Promise.reject("retry too much")):(r.retryCount+=1,t.call.apply(t,yt([r],n)))}},e.prototype.updateBlockProgress=function(t){this.blockUploadInfo={offset:t.offset,context:t.context},this.saveBlockContext()},e.prototype.updateProgressFromBlock=function(t){var e=this.blockUploadInfo.offset,r=t.sent;if(r){var n=e+r;this.updateProgress({percent:Math.min(1,n/this._originFile.size),total:this._originFile.size,sent:n})}},e.prototype.saveBlockContext=function(){this.blockUploadInfo.context&&this.signature&&this.storage&&this.storage.set(this.fileKey,{context:this.blockUploadInfo.context,signature:this.signature})},e.prototype.removeBlockContext=function(){this.updateBlockProgress({offset:0,context:""}),this.storage&&this.storage.remove(this.fileKey)},e.prototype.fetchBlockUploadServer=function(){if(!this.signature)return Promise.reject();var t=this.signature;wt[t.bucketName]||(wt[t.bucketName]={index:0,lbs:this._fetchAdapter({url:this._apis.FETCH_BLOCK_UPLOAD_SERVER.url+"?version=1.0&bucketname="+t.bucketName,method:"GET",headers:{"x-nos-token":t.token}}).then((function(t){return t.body.upload}))});var e=wt[t.bucketName];return e.lbs.then((function(t){var r=t[e.index],n=e.index+1;return n===t.length&&(n=0),e.index=n,r.replace("http://","https://")}))},e.prototype.fetchUploadOffsetFromRemote=function(){var t=this,e=this.signature;if(!e)throw new Error;if(!this.blockUploadInfo.context)return Promise.resolve();var r=this._apis.FETCH_BLOCK_UPLOAD_CONTEXT.url.replace(/\{(\w+)\}/g,(function(t,r){return e[r]||""}));return r+="?uploadContext&version=1.0&context="+this.blockUploadInfo.context,this._fetchAdapter({url:r,method:"GET",headers:{"x-nos-token":e.token}}).then((function(e){var r=e.body;r.errCode?(t.removeBlockContext(),t.setError(r.errMsg)):t.updateBlockProgress({offset:r.offset,context:t.blockUploadInfo.context})}),(function(){t.removeBlockContext()}))},e.prototype.uploadNextBlock=function(){return vt(this,void 0,void 0,(function(){var t,e,r,n,o,i,a,s,u,l,f,c=this;return bt(this,(function(p){if(!this.signature)throw new Error("signature not");return t=this._originFile,e=this.signature,r=this.blockUploadInfo,n=r.offset,o=void 0===n?0:n,i=r.context,a=Nt.fileSlice(t,o,this.blockSize),Pt.log("blobBlock",a,o),s=o+a.size>=t.size,u=Nt.urlReplace(this._apis.NOS_BLOCK_UPLOAD.url,this.signature),l={offset:o,complete:s,context:i,version:"1.0"},f=Object.keys(l).map((function(t){return t+"="+l[t]})),u+="?"+f.join("&"),[2,new Promise((function(t,r){var n=c._adapter({url:u,file:a,type:"blob",fileKey:"file",headers:{"x-nos-token":e.token},timeout:18e5,success:function(e){if(e.errCode)r("nos error");else{var n=e.body;t(n)}},error:function(){r("network")},progress:function(t){c.updateProgressFromBlock(t)}}).abort;c._abort=n}))]}))}))},e.prototype.abort=function(){this._abort&&this._abort(),this.removeBlockContext(),this._aborted=!0},e.prototype.isAllBlockCompleted=function(){return this.blockUploadInfo.offset>=this._originFile.size},e.prototype.startBlockUpload=function(){var t=this;return this._aborted?Promise.reject("abort"):this.uploadNextBlock().catch((function(){return t.createRetry(t.startBlockUpload)(),Promise.reject()})).then((function(e){t.clearRetry(),t.updateBlockProgress(e),t.updateProgress({percent:Math.min(1,e.offset/t._originFile.size),total:t._originFile.size,sent:e.offset})})).then((function(){return vt(t,void 0,void 0,(function(){return bt(this,(function(t){switch(t.label){case 0:return this.isAllBlockCompleted()?[4,this.setComplete()]:[3,3];case 1:return t.sent(),[4,this.removeBlockContext()];case 2:return t.sent(),[2,this.uploadedInfo];case 3:return[2,this.startBlockUpload()]}}))}))}))},e.prototype.fetchUnCompleteBlobBlockInfo=function(){return this.storage&&this.storage.get(this.fileKey)},e.prototype.upload=function(){return vt(this,void 0,void 0,(function(){var t,e;return bt(this,(function(r){switch(r.label){case 0:return[4,this.fetchUnCompleteBlobBlockInfo()];case 1:return(t=r.sent())?[3,3]:(e=this,[4,this.getNOSToken()]);case 2:return e.signature=r.sent(),[3,4];case 3:this.signature=t.signature,r.label=4;case 4:return[4,this.fetchUploadOffsetFromRemote()];case 5:return r.sent(),[2,this.startBlockUpload()]}}))}))},e}(Ot.default);ct.default=At;var xt={},St={},Ct={},kt={};!function(t){var e=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",r="["+e+"][:A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*",n=new RegExp("^"+r+"$");t.isExist=function(t){return void 0!==t},t.isEmptyObject=function(t){return 0===Object.keys(t).length},t.merge=function(t,e,r){if(e)for(var n=Object.keys(e),o=n.length,i=0;i<o;i++)t[n[i]]="strict"===r?[e[n[i]]]:e[n[i]]},t.getValue=function(e){return t.isExist(e)?e:""},t.buildOptions=function(t,e,r){var n={};if(!t)return e;for(var o=0;o<r.length;o++)void 0!==t[r[o]]?n[r[o]]=t[r[o]]:n[r[o]]=e[r[o]];return n},t.isTagNameInArrayMode=function(t,e,r){return!1!==e&&(e instanceof RegExp?e.test(t):"function"==typeof e?!!e(t,r):"strict"===e)},t.isName=function(t){var e=n.exec(t);return!(null==e)},t.getAllMatches=function(t,e){for(var r=[],n=e.exec(t);n;){for(var o=[],i=n.length,a=0;a<i;a++)o.push(n[a]);r.push(o),n=e.exec(t)}return r},t.nameRegexp=r}(kt);var Et=kt;Ct.convertToJson=function t(e,r,n){var o={};if((!e.child||Et.isEmptyObject(e.child))&&(!e.attrsMap||Et.isEmptyObject(e.attrsMap)))return Et.isExist(e.val)?e.val:"";if(Et.isExist(e.val)&&("string"!=typeof e.val||""!==e.val&&e.val!==r.cdataPositionChar)){var i=Et.isTagNameInArrayMode(e.tagname,r.arrayMode,n);o[r.textNodeName]=i?[e.val]:e.val}Et.merge(o,e.attrsMap,r.arrayMode);for(var a=Object.keys(e.child),s=0;s<a.length;s++){var u=a[s];if(e.child[u]&&e.child[u].length>1)for(var l in o[u]=[],e.child[u])e.child[u].hasOwnProperty(l)&&o[u].push(t(e.child[u][l],r,u));else{var f=t(e.child[u][0],r,u),c=!0===r.arrayMode&&"object"==typeof f||Et.isTagNameInArrayMode(u,r.arrayMode,n);o[u]=c?[f]:f}}return o};var Tt={},jt=kt,It=kt.buildOptions,Ut=function(t,e,r){this.tagname=t,this.parent=e,this.child={},this.attrsMap={},this.val=r,this.addChild=function(t){Array.isArray(this.child[t.tagname])?this.child[t.tagname].push(t):this.child[t.tagname]=[t]}};"<((!\\[CDATA\\[([\\s\\S]*?)(]]>))|((NAME:)?(NAME))([^>]*)>|((\\/)(NAME)\\s*>))([^<]*)".replace(/NAME/g,jt.nameRegexp),!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt),!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat);var Mt={attributeNamePrefix:"@_",attrNodeName:!1,textNodeName:"#text",ignoreAttributes:!0,ignoreNameSpace:!1,allowBooleanAttributes:!1,parseNodeValue:!0,parseAttributeValue:!1,arrayMode:!1,trimValues:!0,cdataTagName:!1,cdataPositionChar:"\\c",tagValueProcessor:function(t,e){return t},attrValueProcessor:function(t,e){return t},stopNodes:[]};Tt.defaultOptions=Mt;var Bt=["attributeNamePrefix","attrNodeName","textNodeName","ignoreAttributes","ignoreNameSpace","allowBooleanAttributes","parseNodeValue","parseAttributeValue","arrayMode","trimValues","cdataTagName","cdataPositionChar","tagValueProcessor","attrValueProcessor","parseTrueNumberOnly","stopNodes"];function Dt(t,e,r){return e&&(r.trimValues&&(e=e.trim()),e=Rt(e=r.tagValueProcessor(e,t),r.parseNodeValue,r.parseTrueNumberOnly)),e}function Ft(t,e){if(e.ignoreNameSpace){var r=t.split(":"),n="/"===t.charAt(0)?"/":"";if("xmlns"===r[0])return"";2===r.length&&(t=n+r[1])}return t}function Rt(t,e,r){var n;return e&&"string"==typeof t?(""===t.trim()||isNaN(t)?n="true"===t||"false"!==t&&t:(-1!==t.indexOf("0x")?n=Number.parseInt(t,16):-1!==t.indexOf(".")?(n=Number.parseFloat(t),t=t.replace(/\.?0+$/,"")):n=Number.parseInt(t,10),r&&(n=String(n)===t?n:t)),n):jt.isExist(t)?t:""}Tt.props=Bt;var Lt=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])(.*?)\\3)?","g");function Vt(t,e){if(!e.ignoreAttributes&&"string"==typeof t){t=t.replace(/\r?\n/g," ");for(var r=jt.getAllMatches(t,Lt),n=r.length,o={},i=0;i<n;i++){var a=Ft(r[i][1],e);a.length&&(void 0!==r[i][4]?(e.trimValues&&(r[i][4]=r[i][4].trim()),r[i][4]=e.attrValueProcessor(r[i][4],a),o[e.attributeNamePrefix+a]=Rt(r[i][4],e.parseAttributeValue,e.parseTrueNumberOnly)):e.allowBooleanAttributes&&(o[e.attributeNamePrefix+a]=!0))}if(!Object.keys(o).length)return;if(e.attrNodeName){var s={};return s[e.attrNodeName]=o,s}return o}}function zt(t,e){for(var r,n="",o=e;o<t.length;o++){var i=t[o];if(r)i===r&&(r="");else if('"'===i||"'"===i)r=i;else{if(">"===i)return{data:n,index:o};"\t"===i&&(i=" ")}n+=i}}function Kt(t,e,r,n){var o=t.indexOf(e,r);if(-1===o)throw new Error(n);return o+e.length-1}Tt.getTraversalObj=function(t,e){t=t.replace(/\r\n?/g,"\n"),e=It(e,Mt,Bt);for(var r=new Ut("!xml"),n=r,o="",i=0;i<t.length;i++){if("<"===t[i])if("/"===t[i+1]){var a=Kt(t,">",i,"Closing Tag is not closed."),s=t.substring(i+2,a).trim();if(e.ignoreNameSpace){var u=s.indexOf(":");-1!==u&&(s=s.substr(u+1))}n&&(n.val?n.val=jt.getValue(n.val)+""+Dt(s,o,e):n.val=Dt(s,o,e)),e.stopNodes.length&&e.stopNodes.includes(n.tagname)&&(n.child=[],null==n.attrsMap&&(n.attrsMap={}),n.val=t.substr(n.startIndex+1,i-n.startIndex-1)),n=n.parent,o="",i=a}else if("?"===t[i+1])i=Kt(t,"?>",i,"Pi Tag is not closed.");else if("!--"===t.substr(i+1,3))i=Kt(t,"--\x3e",i,"Comment is not closed.");else if("!D"===t.substr(i+1,2)){var l=Kt(t,">",i,"DOCTYPE is not closed.");i=t.substring(i,l).indexOf("[")>=0?t.indexOf("]>",i)+1:l}else if("!["===t.substr(i+1,2)){var f=Kt(t,"]]>",i,"CDATA is not closed.")-2,c=t.substring(i+9,f);if(o&&(n.val=jt.getValue(n.val)+""+Dt(n.tagname,o,e),o=""),e.cdataTagName){var p=new Ut(e.cdataTagName,n,c);n.addChild(p),n.val=jt.getValue(n.val)+e.cdataPositionChar,c&&(p.val=c)}else n.val=(n.val||"")+(c||"");i=f+2}else{var d=zt(t,i+1),h=d.data,g=d.index,v=h.indexOf(" "),b=h,y=!0;if(-1!==v&&(b=h.substr(0,v).replace(/\s\s*$/,""),h=h.substr(v+1)),e.ignoreNameSpace){var m=b.indexOf(":");-1!==m&&(y=(b=b.substr(m+1))!==d.data.substr(m+1))}if(n&&o&&"!xml"!==n.tagname&&(n.val=jt.getValue(n.val)+""+Dt(n.tagname,o,e)),h.length>0&&h.lastIndexOf("/")===h.length-1){h="/"===b[b.length-1]?b=b.substr(0,b.length-1):h.substr(0,h.length-1);var _=new Ut(b,n,"");b!==h&&(_.attrsMap=Vt(h,e)),n.addChild(_)}else{var O=new Ut(b,n);e.stopNodes.length&&e.stopNodes.includes(O.tagname)&&(O.startIndex=g),b!==h&&y&&(O.attrsMap=Vt(h,e)),n.addChild(O),n=O}o="",i=g}else o+=t[i]}return r};var Wt={},Gt=kt,Jt={allowBooleanAttributes:!1},Ht=["allowBooleanAttributes"];function Xt(t,e){for(var r=e;e<t.length;e++)if("?"!=t[e]&&" "!=t[e]);else{var n=t.substr(r,e-r);if(e>5&&"xml"===n)return te("InvalidXml","XML declaration allowed only at the start of the document.",re(t,e));if("?"==t[e]&&">"==t[e+1]){e++;break}}return e}function qt(t,e){if(t.length>e+5&&"-"===t[e+1]&&"-"===t[e+2]){for(e+=3;e<t.length;e++)if("-"===t[e]&&"-"===t[e+1]&&">"===t[e+2]){e+=2;break}}else if(t.length>e+8&&"D"===t[e+1]&&"O"===t[e+2]&&"C"===t[e+3]&&"T"===t[e+4]&&"Y"===t[e+5]&&"P"===t[e+6]&&"E"===t[e+7]){var r=1;for(e+=8;e<t.length;e++)if("<"===t[e])r++;else if(">"===t[e]&&0===--r)break}else if(t.length>e+9&&"["===t[e+1]&&"C"===t[e+2]&&"D"===t[e+3]&&"A"===t[e+4]&&"T"===t[e+5]&&"A"===t[e+6]&&"["===t[e+7])for(e+=8;e<t.length;e++)if("]"===t[e]&&"]"===t[e+1]&&">"===t[e+2]){e+=2;break}return e}Wt.validate=function(t,e){e=Gt.buildOptions(e,Jt,Ht);var r,n=[],o=!1,i=!1;"\ufeff"===t[0]&&(t=t.substr(1));for(var a=0;a<t.length;a++)if("<"===t[a]&&"?"===t[a+1]){if((a=Xt(t,a+=2)).err)return a}else{if("<"!==t[a]){if(" "===t[a]||"\t"===t[a]||"\n"===t[a]||"\r"===t[a])continue;return te("InvalidChar","char '"+t[a]+"' is not expected.",re(t,a))}if("!"===t[++a]){a=qt(t,a);continue}var s=!1;"/"===t[a]&&(s=!0,a++);for(var u="";a<t.length&&">"!==t[a]&&" "!==t[a]&&"\t"!==t[a]&&"\n"!==t[a]&&"\r"!==t[a];a++)u+=t[a];if("/"===(u=u.trim())[u.length-1]&&(u=u.substring(0,u.length-1),a--),r=u,!Gt.isName(r)){return te("InvalidTag",0===u.trim().length?"There is an unnecessary space between tag name and backward slash '</ ..'.":"Tag '"+u+"' is an invalid name.",re(t,a))}var l=Yt(t,a);if(!1===l)return te("InvalidAttr","Attributes for '"+u+"' have open quote.",re(t,a));var f=l.value;if(a=l.index,"/"===f[f.length-1]){var c=Qt(f=f.substring(0,f.length-1),e);if(!0!==c)return te(c.err.code,c.err.msg,re(t,a-f.length+c.err.line));o=!0}else if(s){if(!l.tagClosed)return te("InvalidTag","Closing tag '"+u+"' doesn't have proper closing.",re(t,a));if(f.trim().length>0)return te("InvalidTag","Closing tag '"+u+"' can't have attributes or invalid starting.",re(t,a));var p=n.pop();if(u!==p)return te("InvalidTag","Closing tag '"+p+"' is expected inplace of '"+u+"'.",re(t,a));0==n.length&&(i=!0)}else{var d=Qt(f,e);if(!0!==d)return te(d.err.code,d.err.msg,re(t,a-f.length+d.err.line));if(!0===i)return te("InvalidXml","Multiple possible root nodes found.",re(t,a));n.push(u),o=!0}for(a++;a<t.length;a++)if("<"===t[a]){if("!"===t[a+1]){a=qt(t,++a);continue}if("?"!==t[a+1])break;if((a=Xt(t,++a)).err)return a}else if("&"===t[a]){var h=Zt(t,a);if(-1==h)return te("InvalidChar","char '&' is not expected.",re(t,a));a=h}"<"===t[a]&&a--}return o?!(n.length>0)||te("InvalidXml","Invalid '"+JSON.stringify(n,null,4).replace(/\r?\n/g,"")+"' found.",1):te("InvalidXml","Start tag expected.",1)};function Yt(t,e){for(var r="",n="",o=!1;e<t.length;e++){if('"'===t[e]||"'"===t[e])if(""===n)n=t[e];else{if(n!==t[e])continue;n=""}else if(">"===t[e]&&""===n){o=!0;break}r+=t[e]}return""===n&&{value:r,index:e,tagClosed:o}}var $t=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function Qt(t,e){for(var r=Gt.getAllMatches(t,$t),n={},o=0;o<r.length;o++){if(0===r[o][1].length)return te("InvalidAttr","Attribute '"+r[o][2]+"' has no space in starting.",ne(t,r[o][0]));if(void 0===r[o][3]&&!e.allowBooleanAttributes)return te("InvalidAttr","boolean attribute '"+r[o][2]+"' is not allowed.",ne(t,r[o][0]));var i=r[o][2];if(!ee(i))return te("InvalidAttr","Attribute '"+i+"' is an invalid name.",ne(t,r[o][0]));if(n.hasOwnProperty(i))return te("InvalidAttr","Attribute '"+i+"' is repeated.",ne(t,r[o][0]));n[i]=1}return!0}function Zt(t,e){if(";"===t[++e])return-1;if("#"===t[e])return function(t,e){var r=/\d/;for("x"===t[e]&&(e++,r=/[\da-fA-F]/);e<t.length;e++){if(";"===t[e])return e;if(!t[e].match(r))break}return-1}(t,++e);for(var r=0;e<t.length;e++,r++)if(!(t[e].match(/\w/)&&r<20)){if(";"===t[e])break;return-1}return e}function te(t,e,r){return{err:{code:t,msg:e,line:r}}}function ee(t){return Gt.isName(t)}function re(t,e){return t.substring(0,e).split(/\r?\n/).length}function ne(t,e){return t.indexOf(e)+e.length}var oe={},ie=function(t){return String.fromCharCode(t)},ae={nilChar:ie(176),missingChar:ie(201),nilPremitive:ie(175),missingPremitive:ie(200),emptyChar:ie(178),emptyValue:ie(177),boundryChar:ie(179),objStart:ie(198),arrStart:ie(204),arrayEnd:ie(185)},se=[ae.nilChar,ae.nilPremitive,ae.missingChar,ae.missingPremitive,ae.boundryChar,ae.emptyChar,ae.emptyValue,ae.arrayEnd,ae.objStart,ae.arrStart],ue=function t(e,r,n){if("string"==typeof r)return e&&e[0]&&void 0!==e[0].val?le(e[0].val):le(e);var o,i=void 0===(o=e)?ae.missingChar:null===o?ae.nilChar:!(o.child&&0===Object.keys(o.child).length&&(!o.attrsMap||0===Object.keys(o.attrsMap).length))||ae.emptyChar;if(!0===i){var a="";if(Array.isArray(r)){a+=ae.arrStart;var s=r[0],u=e.length;if("string"==typeof s)for(var l=0;l<u;l++){var f=le(e[l].val);a=fe(a,f)}else for(var c=0;c<u;c++){var p=t(e[c],s,n);a=fe(a,p)}a+=ae.arrayEnd}else{a+=ae.objStart;var d=Object.keys(r);for(var h in Array.isArray(e)&&(e=e[0]),d){var g=d[h],v=void 0;v=!n.ignoreAttributes&&e.attrsMap&&e.attrsMap[g]?t(e.attrsMap[g],r[g],n):g===n.textNodeName?t(e.val,r[g],n):t(e.child[g],r[g],n),a=fe(a,v)}}return a}return i},le=function(t){switch(t){case void 0:return ae.missingPremitive;case null:return ae.nilPremitive;case"":return ae.emptyValue;default:return t}},fe=function(t,e){return ce(e[0])||ce(t[t.length-1])||(t+=ae.boundryChar),t+e},ce=function(t){return-1!==se.indexOf(t)};var pe=Tt,de=kt.buildOptions;oe.convert2nimn=function(t,e,r){return r=de(r,pe.defaultOptions,pe.props),ue(t,e,r)};var he={},ge=kt,ve=kt.buildOptions,be=Tt,ye=function t(e,r,n){for(var o,i="{",a=Object.keys(e.child),s=0;s<a.length;s++){var u=a[s];if(e.child[u]&&e.child[u].length>1){for(var l in i+='"'+u+'" : [ ',e.child[u])i+=t(e.child[u][l],r)+" , ";i=i.substr(0,i.length-1)+" ] "}else i+='"'+u+'" : '+t(e.child[u][0],r)+" ,"}return ge.merge(i,e.attrsMap),ge.isEmptyObject(i)?ge.isExist(e.val)?e.val:"":(ge.isExist(e.val)&&("string"!=typeof e.val||""!==e.val&&e.val!==r.cdataPositionChar)&&(i+='"'+r.textNodeName+'" : '+(!0!==(o=e.val)&&!1!==o&&isNaN(o)?'"'+o+'"':o)),","===i[i.length-1]&&(i=i.substr(0,i.length-2)),i+"}")};he.convertToJsonString=function(t,e){return(e=ve(e,be.defaultOptions,be.props)).indentBy=e.indentBy||"",ye(t,e)};var me=kt.buildOptions,_e={attributeNamePrefix:"@_",attrNodeName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataTagName:!1,cdataPositionChar:"\\c",format:!1,indentBy:"  ",supressEmptyNode:!1,tagValueProcessor:function(t){return t},attrValueProcessor:function(t){return t}},Oe=["attributeNamePrefix","attrNodeName","textNodeName","ignoreAttributes","cdataTagName","cdataPositionChar","format","indentBy","supressEmptyNode","tagValueProcessor","attrValueProcessor"];function Ne(t){this.options=me(t,_e,Oe),this.options.ignoreAttributes||this.options.attrNodeName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Ee),this.options.cdataTagName?this.isCDATA=Te:this.isCDATA=function(){return!1},this.replaceCDATAstr=Pe,this.replaceCDATAarr=we,this.options.format?(this.indentate=ke,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine=""),this.options.supressEmptyNode?(this.buildTextNode=Ce,this.buildObjNode=xe):(this.buildTextNode=Se,this.buildObjNode=Ae),this.buildTextValNode=Se,this.buildObjectNode=Ae}function Pe(t,e){return t=this.options.tagValueProcessor(""+t),""===this.options.cdataPositionChar||""===t?t+"<![CDATA["+e+"]]"+this.tagEndChar:t.replace(this.options.cdataPositionChar,"<![CDATA["+e+"]]"+this.tagEndChar)}function we(t,e){if(t=this.options.tagValueProcessor(""+t),""===this.options.cdataPositionChar||""===t)return t+"<![CDATA["+e.join("]]><![CDATA[")+"]]"+this.tagEndChar;for(var r in e)t=t.replace(this.options.cdataPositionChar,"<![CDATA["+e[r]+"]]>");return t+this.newLine}function Ae(t,e,r,n){return r&&!t.includes("<")?this.indentate(n)+"<"+e+r+">"+t+"</"+e+this.tagEndChar:this.indentate(n)+"<"+e+r+this.tagEndChar+t+this.indentate(n)+"</"+e+this.tagEndChar}function xe(t,e,r,n){return""!==t?this.buildObjectNode(t,e,r,n):this.indentate(n)+"<"+e+r+"/"+this.tagEndChar}function Se(t,e,r,n){return this.indentate(n)+"<"+e+r+">"+this.options.tagValueProcessor(t)+"</"+e+this.tagEndChar}function Ce(t,e,r,n){return""!==t?this.buildTextValNode(t,e,r,n):this.indentate(n)+"<"+e+r+"/"+this.tagEndChar}function ke(t){return this.options.indentBy.repeat(t)}function Ee(t){return!!t.startsWith(this.options.attributeNamePrefix)&&t.substr(this.attrPrefixLen)}function Te(t){return t===this.options.cdataTagName}Ne.prototype.parse=function(t){return this.j2x(t,0).val},Ne.prototype.j2x=function(t,e){for(var r="",n="",o=Object.keys(t),i=o.length,a=0;a<i;a++){var s=o[a];if(void 0===t[s]);else if(null===t[s])n+=this.indentate(e)+"<"+s+"/"+this.tagEndChar;else if(t[s]instanceof Date)n+=this.buildTextNode(t[s],s,"",e);else if("object"!=typeof t[s]){var u=this.isAttribute(s);u?r+=" "+u+'="'+this.options.attrValueProcessor(""+t[s])+'"':this.isCDATA(s)?t[this.options.textNodeName]?n+=this.replaceCDATAstr(t[this.options.textNodeName],t[s]):n+=this.replaceCDATAstr("",t[s]):s===this.options.textNodeName?t[this.options.cdataTagName]||(n+=this.options.tagValueProcessor(""+t[s])):n+=this.buildTextNode(t[s],s,"",e)}else if(Array.isArray(t[s]))if(this.isCDATA(s))n+=this.indentate(e),t[this.options.textNodeName]?n+=this.replaceCDATAarr(t[this.options.textNodeName],t[s]):n+=this.replaceCDATAarr("",t[s]);else for(var l=t[s].length,f=0;f<l;f++){var c=t[s][f];if(void 0===c);else if(null===c)n+=this.indentate(e)+"<"+s+"/"+this.tagEndChar;else if("object"==typeof c){var p=this.j2x(c,e+1);n+=this.buildObjNode(p.val,s,p.attrStr,e)}else n+=this.buildTextNode(c,s,"",e)}else if(this.options.attrNodeName&&s===this.options.attrNodeName)for(var d=Object.keys(t[s]),h=d.length,g=0;g<h;g++)r+=" "+d[g]+'="'+this.options.attrValueProcessor(""+t[s][d[g]])+'"';else{var v=this.j2x(t[s],e+1);n+=this.buildObjNode(v.val,s,v.attrStr,e)}}return{attrStr:r,val:n}};var je=Ne;!function(t){var e=Ct,r=Tt,n=Tt,o=kt.buildOptions,i=Wt;t.parse=function(t,a,s){if(s){!0===s&&(s={});var u=i.validate(t,s);if(!0!==u)throw Error(u.err.msg)}a=o(a,n.defaultOptions,n.props);var l=r.getTraversalObj(t,a);return e.convertToJson(l,a)},t.convertTonimn=oe.convert2nimn,t.getTraversalObj=r.getTraversalObj,t.convertToJson=e.convertToJson,t.convertToJsonString=he.convertToJsonString,t.validate=i.validate,t.j2xParser=je,t.parseToNimn=function(e,r,n){return t.convertTonimn(t.getTraversalObj(e,n),r,n)}}(St);var Ie,Ue=e&&e.__extends||(Ie=function(t,e){return Ie=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},Ie(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}Ie(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Me=e&&e.__assign||function(){return Me=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},Me.apply(this,arguments)},Be=e&&e.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{u(n.next(t))}catch(t){i(t)}}function s(t){try{u(n.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((n=n.apply(t,e||[])).next())}))},De=e&&e.__generator||function(t,e){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},Fe=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(xt,"__esModule",{value:!0});var Re=Fe(D.exports),Le=St,Ve=Fe(pt),ze=Fe(B),Ke=dt,We=q,Ge=0,Je=1,He=2,Xe=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.blockSize=Ve.default.BLOCK_SIZE,e.retryCount=0,e.partsInfo=[],e.getUploadId=function(){if(!e.signature)throw new Error;return e._fetchAdapter({url:e.getRemoteInitUrl(),method:"POST",responseType:"text",headers:{"x-nos-token":e.signature.token}}).then((function(t){t.headers;var r=t.body;if(r)try{var n=Le.parse(r,{ignoreNameSpace:!0,parseTrueNumberOnly:!0},!0);e.uploadId=n.InitiateMultipartUploadResult.UploadId,e.storage&&e.storage.set(e.fileKey,{uploadId:e.uploadId,size:e.blockSize,signature:e.signature})}catch(t){e.setError(t)}}))},e.abortRemote=function(){if(!e.signature)throw new Error;return e._fetchAdapter({url:e.getRemoteUrl(),method:"DELETE",headers:{"x-nos-token":e.signature.token},responseType:"text"})},e.uploadingAbort={},e.initParts=function(){for(var t=[],r=Math.ceil(e._originFile.size/e.blockSize),n=0;n<r;n++){var o=e.blockSize;n===r-1&&(o=e._originFile.size%e.blockSize),t.push({partNumber:n+1,partStatus:Ge,partSize:o})}e.partsInfo=t},e.checkParts=function(){return e._fetchAdapter({url:e.getRemoteUrl(),method:"GET",headers:{"x-nos-token":e.signature.token},responseType:"text"}).then((function(t){var r=t.body;if(!r)return Promise.reject();var n=Le.parse(r,{ignoreNameSpace:!0},!0);return n.ListPartsResult.Part.length?e.batchEmit((function(){n.ListPartsResult.Part.forEach((function(t){e.updatePartInfo({partNumber:t.PartNumber,partStatus:He,md5:t.ETag})}))})):e.updatePartInfo({partNumber:n.ListPartsResult.Part.PartNumber,md5:n.ListPartsResult.Part.ETag,partStatus:He}),Promise.resolve()}))},e}return Ue(e,t),Object.defineProperty(e.prototype,"uploadingPartCount",{get:function(){return this.partsInfo.filter((function(t){return t.partStatus===Je})).length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uploadedPartCount",{get:function(){return this.partsInfo.filter((function(t){return t.partStatus===He})).length},enumerable:!1,configurable:!0}),e.prototype.allowUploadNew=function(){return this.uploadingPartCount<6},e.prototype.getRemoteInitUrl=function(){if(!this.signature)throw new Error;return Ke.urlReplace(this._apis.NOS_CONCURRENT_UPLOAD.url,this.signature)+"?uploads"},e.prototype.getRemoteUrl=function(t){if(!this.signature)throw new Error;var e=Ke.urlReplace(this._apis.NOS_CONCURRENT_UPLOAD.url,this.signature)+"?";return t&&(e+=Object.keys(t).map((function(e){return e+"="+encodeURIComponent(t[e])})).join("&"),e+="&"),e+="uploadId="+this.uploadId},e.prototype.abort=function(){for(var e in t.prototype.abort.call(this),this.uploadingAbort)Object.prototype.hasOwnProperty.call(this.uploadingAbort,e)&&this.uploadingAbort[e]();this.abortRemote()},e.prototype.updatePartInfo=function(t){var e=this.partsInfo,r=t.partNumber-1;e[r]=Me(Me({},e[r]),t);var n=e.reduce((function(t,e){return t+(e.partStatus===He?e.partSize:e.partSent||0)}),0);this.updateProgress({percent:Math.min(1,n/this._originFile.size),total:this._originFile.size,sent:n})},e.prototype.uploadPart=function(t){return Be(this,void 0,void 0,(function(){var e,r,n=this;return De(this,(function(o){switch(o.label){case 0:return e=Ke.fileSlice(this._originFile,this.blockSize*(t-1),this.blockSize),[4,new Promise((function(t){var r=new FileReader;r.readAsArrayBuffer(e),r.onload=function(e){var r,n=new Re.default.ArrayBuffer;n.append(null===(r=e.target)||void 0===r?void 0:r.result),t(n.end())}}))];case 1:return r=o.sent(),[2,new Promise((function(o,i){var a=n._adapter({url:n.getRemoteUrl({partNumber:t}),file:e,method:"PUT",type:"blob",fileKey:"file",responseType:"text",headers:{"Content-MD5":r,"x-nos-token":n.signature.token},timeout:18e5,success:function(e){delete n.uploadingAbort[t],e.errCode?i("nos error"):o(r)},error:function(){delete n.uploadingAbort[t],i("network")},progress:function(e){n.updateProgressFromBlock(t,e)}}).abort;n.uploadingAbort[t]=a}))]}}))}))},e.prototype.completeAllParts=function(){var t,e=this,r={CompleteMultipartUpload:{Part:this.partsInfo.map((function(t){return{PartNumber:t.partNumber,ETag:t.md5}}))}},n=new Le.j2xParser({}).parse(r);this._fetchAdapter({url:this.getRemoteUrl(),method:"POST",responseType:"text",headers:{"Content-Type":"text/xml","x-nos-token":null===(t=this.signature)||void 0===t?void 0:t.token},body:n}).then((function(t){t.headers,t.body,e.storage&&e.storage.remove(e.fileKey),e.emit("allPartsComplete",null),We.log("upload success",e._originFile.name,new Date)}),(function(t){t.status>0&&e.storage&&e.storage.remove(e.fileKey),e.setError("上传失败")}))},e.prototype.checkAllPartCompleted=function(){return this.partsInfo.every((function(t){return t.partStatus===He}))},e.prototype.updateProgressFromBlock=function(t,e){this.updatePartInfo({partNumber:t,partSent:e.sent||0})},e.prototype.getNextPaddingPartInfo=function(){return this.partsInfo.find((function(t){return t.partStatus===Ge}))},e.prototype.uploadNextBlock=function(){var t=this;if(this.allowUploadNew())if(this.retryCount>=4)this.setError("请检查网络");else{var e=this.getNextPaddingPartInfo();if(e){var r=e.partNumber;this.updatePartInfo({partNumber:r,partStatus:Je}),this.uploadPart(e.partNumber).then((function(e){t.updatePartInfo({md5:e,partNumber:r,partStatus:He}),t.checkAllPartCompleted()?t.completeAllParts():t.uploadNextBlock()}),(function(){t.updatePartInfo({partNumber:r,partStatus:Ge}),t.retryCount++,t.uploadNextBlock()})),this.uploadNextBlock()}}},e.prototype.startBlockUpload=function(){var t=this;return this._aborted?Promise.reject("abort"):(this.checkAllPartCompleted()?this.completeAllParts():this.uploadNextBlock(),new Promise((function(e){t.addListener("allPartsComplete",(function(){return Be(t,void 0,void 0,(function(){return De(this,(function(t){switch(t.label){case 0:return We.logTimeEnd("upload"),[4,this.setComplete()];case 1:return t.sent(),e(this.uploadedInfo),[2]}}))}))}))})))},e.prototype.fetchUnCompleteUploadInfo=function(){return this.storage&&this.storage.get(this.fileKey)},e.prototype.upload=function(){return Be(this,void 0,void 0,(function(){var t,e,r,n;return De(this,(function(o){switch(o.label){case 0:return We.logTime("upload"),[4,this.initParts()];case 1:return o.sent(),[4,this.fetchUnCompleteUploadInfo()];case 2:return(t=o.sent())?[3,5]:(e=this,[4,this.getNOSToken()]);case 3:return e.signature=o.sent(),[4,this.getUploadId()];case 4:return o.sent(),[3,11];case 5:this.signature=t.signature,this.uploadId=t.uploadId,o.label=6;case 6:return o.trys.push([6,8,,11]),[4,this.checkParts()];case 7:return o.sent(),[3,11];case 8:return r=o.sent(),We.log("checkParts fail",r),delete this.signature,delete this.uploadId,this.storage&&this.storage.remove(this.fileKey),n=this,[4,this.getNOSToken()];case 9:return n.signature=o.sent(),[4,this.getUploadId()];case 10:return o.sent(),[3,11];case 11:return[2,this.startBlockUpload()]}}))}))},e}(ze.default);xt.default=Xe,function(t){var r=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(t,"__esModule",{value:!0}),t.BlockNOS=t.NOS=t.NOSUploader=t.NOSConcurrentUploader=t.NOSBlockUploader=t.NOSClass=t.NOSDefaultUploader=void 0;var n=o;Object.defineProperty(t,"NOSClass",{enumerable:!0,get:function(){return n.NOSClass}});var i=r(M);t.NOSDefaultUploader=i.default;var a=r(ct);t.NOSBlockUploader=a.default;var s=r(xt);t.NOSConcurrentUploader=s.default;var u=r(B);t.NOSUploader=u.default,t.NOS=new n.NOSClass(i.default),t.BlockNOS=new n.NOSClass(a.default)}(n);var qe={},Ye={};function $e(t,e){"function"==typeof e&&e(t)}Object.defineProperty(Ye,"__esModule",{value:!0}),Ye.default=function(t){var e=t.url,r=t.method,n=t.body,o=t.headers,i=void 0===o?{}:o,a=t.async,s=void 0===a||a,u=t.timeout,l=t.responseType,f=void 0===l?"json":l,c=t.onSuccess,p=t.onError,d=function(){var t="undefined"!=typeof window?window:null;if(!t||void 0===t.XMLHttpRequest)throw new Error("XMLHttpRequest not support");return new t.XMLHttpRequest}(),h={xhr:d,url:e,end:!1,aborted:!1,abort:function(){},send:function(){}};return h.abort=function(t,e){return function(){var r=t.xhr;4===r.readyState||t.end||(t.end=!0,r.abort(),t.aborted=!0,$e(t,e))}}(h,p),d.open(r,e,s),f&&(d.responseType=f),s&&u&&u>0&&(d.timeout=u),Object.keys(i).forEach((function(t){"content-type"===t.toLowerCase()&&"[object FormData]"===Object.prototype.toString.call(n)||d.setRequestHeader(t,i[t])})),d.onreadystatechange=function(){4===d.readyState?d.status>=200&&d.status<300?$e(h,c):$e(h,p):d.readyState<2&&d.status>0&&$e(h,p)},h.send=function(){d.send(n)},h};var Qe={};Object.defineProperty(Qe,"__esModule",{value:!0}),Qe.storage=void 0,Qe.storage={set:function(t,e){localStorage.setItem(t,JSON.stringify(e))},remove:function(t){localStorage.removeItem(t)},get:function(t){var e=localStorage.getItem(t);return e?JSON.parse(e):null}};var Ze=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(qe,"__esModule",{value:!0}),qe.WebAdapter=void 0;var tr=Ze(Ye),er=Qe;qe.WebAdapter={uploader:function(t){var e,r=t.url,n=t.type,o=t.method,i=t.fileKey,a=t.file,s=t.headers,u=t.data,l=t.responseType,f=t.success,c=t.error,p=t.progress;if("blob"===n)e=a;else{var d=new FormData;u&&Object.keys(u).forEach((function(t){var e=u[t];return d.append(t,e),d}),new FormData),d.append(i,a),e=d}var h=l||"json",g=tr.default({url:r,method:o||"POST",body:e,headers:s,responseType:h,onSuccess:function(t){var e=t.xhr,r=e.response;if("json"===h&&"string"==typeof e.response)try{r=JSON.parse(r)}catch(t){}f({status:e.status,headers:e.getAllResponseHeaders(),body:r})},onError:function(t){var e=t.xhr,r=e.response;if("json"===h&&"string"==typeof e.response)try{r=JSON.parse(r)}catch(t){}c({status:e.status,headers:e.getAllResponseHeaders(),body:r})}});return g.xhr.upload.addEventListener("progress",(function(t){p({percent:t.loaded/t.total,sent:t.loaded,total:t.total})}),!1),g.send(),{abort:function(){return g.abort()}}},fetch:function(t){var e=t.url,r=t.method,n=t.headers,o=t.body,i=t.responseType;return new Promise((function(t,a){var s=tr.default({url:e,method:r,headers:n,body:o,responseType:i||"json",onSuccess:function(e){var r=e.xhr;t({headers:r.getAllResponseHeaders(),body:r.response||r.responseText})},onError:function(t){var e=t.xhr;a({status:e.status,headers:e.getAllResponseHeaders(),body:e.response||e.responseText})}});return s.send(),{abort:function(){return s.abort()}}}))},storage:er.storage},function(t){var r,o=e&&e.__extends||(r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},r(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),t.ConcurrentNOSWeb=t.BlockNOSWeb=t.NOSWeb=t.NOSWebClass=t.NOSConcurrentUploader=t.NOSDefaultUploader=t.NOSBlockUploader=t.NOSUploader=t.NOSClass=t.WebAdapter=void 0;var i=n;Object.defineProperty(t,"NOSClass",{enumerable:!0,get:function(){return i.NOSClass}}),Object.defineProperty(t,"NOSUploader",{enumerable:!0,get:function(){return i.NOSUploader}}),Object.defineProperty(t,"NOSConcurrentUploader",{enumerable:!0,get:function(){return i.NOSConcurrentUploader}}),Object.defineProperty(t,"NOSBlockUploader",{enumerable:!0,get:function(){return i.NOSBlockUploader}}),Object.defineProperty(t,"NOSDefaultUploader",{enumerable:!0,get:function(){return i.NOSDefaultUploader}});var a=qe;Object.defineProperty(t,"WebAdapter",{enumerable:!0,get:function(){return a.WebAdapter}});var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.uploadAdapter=a.WebAdapter.uploader,e.fetchAdapter=a.WebAdapter.fetch,e.storage=a.WebAdapter.storage,e}return o(e,t),e}(i.NOSClass);t.NOSWebClass=s,t.NOSWeb=new s(i.NOSDefaultUploader),t.BlockNOSWeb=new s(i.NOSBlockUploader),t.ConcurrentNOSWeb=new s(i.NOSConcurrentUploader)}(r),t.__moduleExports=r,Object.defineProperty(t,"__esModule",{value:!0})}));
